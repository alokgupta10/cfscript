- step:
    name: Setup Secrets and Env
    identifier: setup_secrets_env
    type: Run
    spec:
      shell: Sh
      command: |
        set -e

        echo ">>> Creating cci_secrets directory"
        mkdir -p /harness/cci_secrets

        echo ">>> Writing MySQL credentials from Harness Secrets"
        echo "${MYSQL_PASSWORD}" > /harness/cci_secrets/mysql_password.txt
        echo "${MYSQL_ROOT_PASSWORD}" > /harness/cci_secrets/mysql_root_password.txt

        echo ">>> Creating top-level .env with COMPOSE_PROJECT_NAME"
        echo 'COMPOSE_PROJECT_NAME="cci"' > /harness/.env

        echo ">>> Creating app module .env"
        mkdir -p /harness/app
        echo 'COMPOSE_PROJECT_NAME="cci"' > /harness/app/.env

        echo ">>> Secrets and .env setup completed"
      envVariables:
        MYSQL_PASSWORD: <+secrets.getValue("org.mysql_password")>
        MYSQL_ROOT_PASSWORD: <+secrets.getValue("org.mysql_root_password")>
